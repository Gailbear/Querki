@(rc:RequestContext, unknownName:Option[String] = None)

@import play.api.Logger

@space = @{ rc.state.get }
@thing = @{
  rc.thing match {
    case Some(t) => t
    case None => space
  }
}
@title = @{
  rc.thing match {
    case Some(t) => t.displayName
    case None => unknownName.map(models.system.NameType.toDisplay(_)).getOrElse(space.displayName)
  }
}
@isUnknown = @{ unknownName.isDefined }

@main(QuerkiTemplate.Thing, title, rc, true) {

    <script>
      $(function() {
        $(".clickToEdit").on("dblclick", function() {
        // TODO (justin 5/22/13): personally, I like this, but I suspect it is begging for disaster to have it
        // be universal. Later, we should add it back in as an optional user preference.
        //  window.location = "@routes.Application.editThing(rc.ownerName, space.toThingId, thing.toThingId)";
        });
        
        function showStatus(msg) {
          $("#statusText").text(msg);
          $("#statusLine").show();
        }
        
        function finishStatus(msg) {
          $("#statusText").text(msg);
          $("#statusLine").show().delay(4000).hide("slow");
        }

		function updateValue(evt) {
		  var target = $(evt.target);
		  var prop = target.data("prop");
		  var thingId = target.data("thing");
		  var v;
		  if (target.attr('type') == "checkbox") {
		    v = target.prop('checked');
		  } else {
		    v = target.val();
		  }
	      jsRoutes.controllers.Application.setProperty("@space.owner.toThingId", "@space.id.toThingId", thingId, prop, v).ajax({
	        success: function (result) {
	          finishStatus("Saved");
	        },
	        error: function (err) {
	          showStatus("Error trying to save. Please reload this page and try again.");
	        }
	      });
	      showStatus("Saving...");
		}
		
		$.fn.makeIconButton = function () {
		  this.each(function () {
		    var btn = $(this);
		    btn.button({
		      icons: {
		        primary: btn.data("icon")
		      },
		      text: false
		    });
		  });
		}
				
		$(".propEditor").change(updateValue);
		$(".buttonset").buttonset();
		$("._linkButton").button();
		$("._iconButton").makeIconButton();
      });
    </script>
    
    <style>
      .statusLine {
        display: none;
        position: absolute;
        left: 30px;
        top: 40px;
        z-index: 100;
      }
    </style>

	<div id="statusLine" class="statusLine"><span id="statusText" class="label label-info">Status</span></div>
	    
    @if(rc.hasProp) {
    
      @Html(thing.render(rc, rc.prop).display)

    } else {
	  <div class="clickToEdit">

        @if(!rc.chromeless) {
	    <div class="page-header">
	      <h1>@title</h1>
	    </div>
	    }
	
	    @if(isUnknown) {
	      @Html(space.renderUnknownName(rc, unknownName.get).display)
	    } else {
	      @Html(thing.render(rc).display)
	    }
	  
	  </div>
	}
}
