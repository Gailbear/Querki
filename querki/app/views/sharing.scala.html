@(rc:RequestContext)

@import helper._
@import helper.twitterBootstrap._

@import querki.html.HtmlRenderer
@import modules.Modules

@space = @{ rc.state.get }

@pageTitle = @{
  "Sharing and Security for " + space.displayName
}

@main(QuerkiTemplate.View, pageTitle, rc) {

  <script>
     $(function() {
       $("#invitees").manifest({
         marcoPolo: false,
         valuesName: "invitees"
       });
     });
  </script>

  <div class="page-header">
	<h1 class="_defaultTitle">@pageTitle <a class="cancelButton btn" href="@routes.Application.thing(rc.ownerHandle, space.toThingId, space.toThingId)">Done</a></h1>
  </div>
  
  <div class="row">
    <div class="span3">
      <ul class="nav nav-list affix">
        <li class="nav-header">Sharing</li>
        <li><a href="#sendInvitations">Send Invitations</a></li>
        <li><a href="#invitees">Outstanding Invitations</a></li>
        <li><a href="#members">Members</a></li>
        <li class="divider"></li>
        <li class="nav-header">Security</li>
      </ul>
    </div>
	
	<div class="span9">
      <section id="sendInvitations">
          <h2>Send Invitations to Join this Space</h2>
          
          <p>Use this form to invite people to become Members of this Space. The Invitation Message may contain the usual Querki Text formatting,
          including [[]]-style expressions; however, links may not yet work quite the way you expect.</p>
          
          <p>Specify invitees by email address. Don't use this form to resend an invitation (if you send this to someone who is already invited,
          it will be ignored); instead, resend the invitation to them using the list of invitees below.</p>
          
          <p>Invitations will have your email address included as the Reply-To, so if the invitees write back, it will go directly to you.
          (Eventually, we may have replies come to you via Querki, but for now, keep in mind that your invitees will see your email address.)</p>
          
          <div class="control-group">
            <label class="control-label">Invitation Message</label>
            <div class="controls">
              @HtmlRenderer.renderPropertyInput(space, Modules.Person.inviteText, space.getDisplayPropVal(Modules.Person.inviteText)(space))
            </div>
          </div>
        
	    @form(routes.LoginController.inviteMembers(rc.ownerHandle, space.toThingId.toString), 'class -> "") {
          <div class="control-group">
            <label class="control-label">Who to Invite (enter email addresses, comma-separated)</label>
            <div class="controls">
              <input type="text" id="invitees" name="inviteesRaw">
            </div>
          </div>
          
          <div class="control-group">
            <div class="controls">
              <input type="submit" value="Invite Members">
            </div>
          </div>
        }
      </section>
      
      <section id="invitees">
        <h2>Outstanding Invitations</h2>
        
        <p>The following invitations have been sent but not yet accepted.</p>
        
        <table class="table table-hover">
          @for(invitee <- space.descendants(modules.Modules.Person.MOIDs.PersonOID, false, true).filterNot(_.hasProp(modules.Modules.Person.identityLink)(space));
               propVal <- invitee.getPropOpt(modules.Modules.Email.emailAddress)(space);
               emailAddr <- propVal.firstOpt;
               addr = emailAddr.addr) {
            <tr class="warning"><td>@addr</td></tr>
          }
        </table>
      </section>

      <section id="members">
        <h2>Members</h2>
        
        <p>The following people are members of this Space.</p>
        
        <table class="table table-hover">
          @for(member <- space.descendants(modules.Modules.Person.MOIDs.PersonOID, false, true).filter(_.hasProp(modules.Modules.Person.identityLink)(space))) {
            <tr class="info"><td>@member.displayName</td></tr>
          }
        </table>
      </section>
      
    </div>
  
  </div>
}
