@(rc:RequestContext, model:Thing, candidateModels:Iterable[Thing], propsSoFar:Seq[(Property[_,_], DisplayPropVal)], otherProps:Seq[Property[_,_]])

@import language.existentials

@import helper._
@import helper.twitterBootstrap._

@import play.api.Logger

@import models.system._
@import models.system.SystemSpace._

@import models.Property._

@import querki.html._

@thing = @{ rc.thing }
@space = @{ rc.state.get }
@isEdit = @{ thing.isDefined }
@isCreate = @{ !isEdit }

@isSubCreate = @{ rc.isTrue("subCreate") }

@isForeign = @{ thing.get.spaceId != space.id }

@canEdit = @{
  // Disable if you are trying to edit something in the wrong Space.
  // At least, for now -- eventually, this will be legal, but will be copy-then-edit. 
  !isEdit || !isForeign
}

@propsInSpace(s:SpaceState) = {
  <optgroup label="Properties in @s.displayName">
    @for(prop <- s.propList.toSeq.sortBy(_.displayName)) {
      <option value="@prop.id.toString">@prop.displayName</option>
    }
  </optgroup>
  @{s.app.map(propsInSpace(_))}
}

@cancelButton = {
  @if(isCreate) {
    <a class="cancelButton btn" href="@routes.Application.thing(rc.ownerName, space.toThingId, space.toThingId)">Cancel</a>
  } else {
    <a class="cancelButton btn" href="@routes.Application.thing(rc.ownerName, space.toThingId, thing.get.toThingId)">Cancel</a>
  }
}

@showInputControl(prop:Property[_,_], v:DisplayPropVal, i:Int) = {
  @HtmlRenderer.renderPropertyInput(space, prop, v)
}

@editButtonClass(v:DisplayPropVal) = @{
  if (v.isInherited)
    "edit-button"
  else
    "revert-button"
}

@showProperty(prop:Property[_,_], v:DisplayPropVal, i:Int) = {
  <div class="control-group @{if(v.isInherited) "inherited"}">
    <label class="control-label">@Html(prop.getProp(PromptProp)(space).renderPlainOr(prop.getProp(NameProp)(space).renderPlain).raw)
      @if(v.hasInheritance) {
        &nbsp;&nbsp;<button data-empty="@v.emptyControlId" data-model-name="@v.inheritedFrom.get.displayName" data-edits="@v.inputControlId" class="@editButtonClass(v) btn-mini">&nbsp;</button>
      } else {
        &nbsp;&nbsp;<button data-empty="@v.emptyControlId" data-edits="@v.inputControlId" class="trash-button btn-mini">&nbsp;</button>      
      }
    </label>
    <div class="controls">
      @showInputControl(prop, v, i)
    </div>
	<input type="hidden" name="field[@i]" value="@prop.id.toString">
	<input type="hidden" name="@v.emptyControlId" id="@v.emptyControlId" value="@v.isInherited.toString">
  </div>
}
@showProp(tupl:((Property[_,_], DisplayPropVal), Int)) = @{
  val ((prop, v), i) = tupl
  showProperty(prop, v, i)
}

@pageTitle = @{
  // TODO: the hardcoded System below should be the name of the Space this thing is from:
  if (isEdit)
    "Editing " +
    (if (isForeign) "System::" else "") +
    thing.get.displayName
  else
    "Create a " + model.displayName
}

@main(QuerkiTemplate.Edit, pageTitle, rc) {

    <style>
      .cancelButton {
        margin-left: 20px;
      }
    </style>
    
    <script>
    
      // Global switch, defined in querki-common.js. The Editor does not do live-update:
      querkiLiveUpdate = false;
    
      // This is essentially a jQuery plugin for the concept of "Edit/Revert Buttons"
      (function( $ ) {
        function inputElem(t) {
          var inputId = t.data("edits");
	      return $("#" + inputId);        
        }
        
        function setEmpty(t, v) {
	      var emptyId = "#" + t.data("empty");
	      var $emptyFlag = $(emptyId);
	      $emptyFlag.val(v);        
        }
        
        function setButton(t, icon, title, cb) {
	      t.button({
	        icons: {
	          primary: icon
	        },
	        text: false
	      });
	      t.attr("title", title);
	      t.off("click");
	      t.on("click", cb);          
        }
      
        $.fn.editButton = function () {
          this.each(function () {
	        var modelName = $(this).data("model-name");
	        $inp = inputElem($(this));
	        $inp.attr("title", "Inherited from " + modelName + "; click the Edit button to change");
	        $inp.val("");
	        $inp.attr("disabled", "disabled");
	        setEmpty($(this), "true");
	        setButton($(this), "ui-icon-pencil", "Edit", handleEditButton);   
          });
        }
      
        $.fn.revertButton = function () {
          this.each(function () {
	        var $inp = inputElem($(this));
	        $inp.removeAttr("disabled");
	        var modelName = $(this).data("model-name");
	        $inp.attr("title", "Overriding " + modelName + "; click the Revert button to go back to the model's value");
	        setEmpty($(this), "false");
	        setButton($(this), "ui-icon-trash", "Revert", handleRevertButton);   
          });
        }
    
        $.fn.trashButton = function () {
          this.each(function () {
	        setButton($(this), "ui-icon-trash", "Remove", handleTrashButton);   
          });
        }
        
        function handleTrashButton(evt) {
          setEmpty($(this), "true");      
          $("#redisplay").val("true");
          $("#mainSubmit").submit();
        }
      
        function handleEditButton(evt) {
          $(this).revertButton();

          var $inp = inputElem($(this));
          $inp.focus();

          return false;
        }
      
        function handleRevertButton(evt) {
          $(this).editButton();
          return false;
        }
        
        $.fn.addListItemButton = function () {
          this.each(function () {
            setButton($(this), "ui-icon-circle-plus", "Add Item", handleAddListItem);
          });
        }
        
        $.fn.deleteListItemButton = function () {
          this.each(function () {
            setButton($(this), "ui-icon-circle-minus", "Delete Item", handleDeleteListItem);
          });
        }

        function dataField(t, fieldName) {
          return "#" + t.data(fieldName);
        }
        
        function viaField(t, fieldName) {
          var controlId = dataField(t, fieldName);
          return $(controlId);
        }
        
        function handleAddListItem(evt) {
          var templateField = $(this).parent().find(".inputTemplate").first();
          var list = $(this).parent().find("ul").first();
          var sizeField = viaField($(this), "size");
          var curSize = Number(sizeField.val());
          var newField = templateField.clone(true);
          newField.attr("name", templateField.data("basename") + "[" + curSize + "]");
          newField.removeClass("inputTemplate");
          newField.show();
          var newLi = $("<li><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span></li>");
          newLi.append(newField);
          var delButton = $("<button class=\"delete-item-button btn-mini\">&nbsp;</button>");
          setButton(delButton, "ui-icon-circle-minus", "Delete Item", handleDeleteListItem);
          newLi.append(delButton);
          list.append(newLi);
          sizeField.val(curSize + 1);
          return false;
        }
        
        function handleDeleteListItem(evt) {
          var targetLi = $(this).parent();
          var sortList = targetLi.parent();
          targetLi.detach();
          renumberList(sortList);
          return false;
        }
        
      }( jQuery ));
              
        
      function renumberList(sortList) {
        var allItems = sortList.children("li");
        var templateField = sortList.parent().find(".inputTemplate").first();
        var baseItemName = templateField.data("basename");
        var i = 0;
        allItems.each(function () {
          var listItem = $(this);
          var inputField = listItem.find(".list-input-element");
          inputField.attr("name", baseItemName + "[" + i + "]");
          i = i + 1;
        });        
      }
        
      function onSortFinished(evt, ui) {
        var itemMoved = ui.item;
        var sortList = itemMoved.parent();
        renumberList(sortList);
      }
       
      var selectCreatingNew; 
      function handleLinkSelectChanged(evt) {
        selectCreatingNew = this;
        var optionSelected = $("option:selected", this);
        if (optionSelected.hasClass("_createNewFromModel")) {
          var modelId = optionSelected.data("model");
          $("#create-instance-iframe").attr("src", "@routes.Application.createThing(rc.ownerName, space.toThingId, None)" + "?cl&subCreate=true&model=" + modelId)
		  $("#create-instance-dialog").dialog("open");
		  return false;          
        } 
      }
      
      function onLinkCreated(newThingId, newDisplayName) {
        $(selectCreatingNew).append('<option value="' + newThingId + '" selected="selected">' + newDisplayName + '</option>');
        $("#create-instance-dialog").dialog("close");
      }
      
      function beginAddProperty() {
        $("#_addPropertyButtonGroup").hide();
        $("#_addPropertyBox").fadeIn();
      }
      
      function handlePropChoice(evt) {
        var propSelect = $("option:selected", this);
        var propId = propSelect.val();
        if (propId.length > 0) {
		  // TODO: nasty abstraction break here. Do we need a Javascript library for generating ThingIds?
          var propThingId = "." + propId;
	      jsRoutes.controllers.Application.getPropertyDisplay("@space.owner.toThingId", "@space.id.toThingId", propThingId, "Display-Text").ajax({
	        success: function (result) {
	          $("#_propInfo").html(result);
	        },
	        error: function (err) {
	          showStatus("Unable to fetch property info!");
	        }
	      });
        } else {
          $("#_propInfo").text(" ");
        }
      }
    
      $(function() {
        $(".edit-button").editButton();
        $(".revert-button").revertButton();
        $(".trash-button").trashButton();
        $(".add-item-button").addListItemButton();
        $(".delete-item-button").deleteListItemButton();
        $(".inputTemplate").hide();
        $(".sortableList").sortable({
          stop:onSortFinished
        });
        
        $("#submitAndAnother").click(function(evt) {
          $("#makeAnother").val("true");
          return true;
        });
        
        $("#_addPropertyButton").click(beginAddProperty);
        
        $("#_propChooser").change(handlePropChoice);
        
        $("._linkSelect").change(handleLinkSelectChanged);
		$("#create-instance-dialog").dialog({
		    autoOpen:false,
		    height: 800,
		    width: 700,
			modal: true,
			buttons: {
		      "Cancel": function () {
			    $(this).dialog("close");
			  }
			},
			close: function () {
			}
		});
		
      });
    </script>
    
    <div id="create-instance-dialog" title="">
      <iframe id="create-instance-iframe" src="" style="width: 95%; height: 95%"></iframe>
    </div>
    
	<div class="page-header">
	    <h1>@pageTitle @cancelButton</h1>
	</div>
	
	@if(!canEdit) {
	  <div class="alert">@thing.get.displayName is not in this Space. It is not yet legal to edit it. You may want to make a local Model from it, and use that instead.</div>
	}
	
	<div class="row-fluid">
	@form(if (thing.isEmpty) { 
	        routes.Application.doCreateThing(rc.ownerName, space.toThingId, Some(isSubCreate))
	      } else { 
	        routes.Application.doEditThing(rc.ownerName, space.toThingId, thing.get.toThingId) 
	      }, 'class -> "form-horizontal") {
	  <fieldset>
	    <input type="hidden" name="model" value="@model.id.toString">
	    
	    <input type="hidden" id="makeAnother" name="makeAnother" value="false">
	    
	    @defining(propsSoFar.zipWithIndex) { allProps =>
          @for(propPair <- allProps) {
            @showProp(propPair)
          }
        }
        <input type="hidden" id="redisplay" name="redisplay" value="">
        
        <div class="control-group">
          <input type="submit" class="control-label btn" value="Add a Property:">
          <div class="controls" style="margin-left:auto">&nbsp;&nbsp;
            <select name="addedProperty">
              <option value="">Choose a Property</option>
              @for(prop <- otherProps) {
                <option value="@prop.id.toString">@prop.displayName</option>
              }
            </select>
          </div>
        </div>
        
        <div id="_addPropertyButtonGroup" class="control-group">
          <div class="controls">
            <a href="#" id="_addPropertyButton" class="btn btn-info"><i class="icon-plus"></i> Add a Property</a>
          </div>
        </div>
        
        <div id="_addPropertyBox" class="well" style="display:none">
          <p>Choose a property from this list of existing properties, or press "Create a New Property" to do something different.</p>
          <div class="span12">
            <div class="span3">
              <p class="offset1">
                <select id="_propChooser" data-placeholder="Choose a Property...">
                  <option value="">Choose a Property...</option>
                  @propsInSpace(space)
                </select>
              </p>
              <p class="offset1">
                <a href="#" id="_addExistingPropertyButton" class="btn btn-info">Add</a>
              </p>
            </div>
            <div class="span9">
              <p id="_propInfo">THIS IS SOME PLACEHOLDER TEXT. PUT PROP INFO HERE!</p>
            </div>
          </div>
          
          <hr/>
          <a href=""#" id="_createPropertyButton" class="btn btn-info">Create a New Property</a>
        </div>
	  
	    <div class="control-group">
	      <div class="controls">
	        <input id="mainSubmit" type="submit" value="Done" class="btn btn-primary" @if(!canEdit) { disabled="disabled" }>
	        @if(isCreate && !isSubCreate) {
	          <input id="submitAndAnother" type="submit" value="Done and Create Another" class="btn">
	        }
	        @cancelButton
	      </div>
	    </div>
	  </fieldset>
	}
	</div>
}